# Smart Commit Workflow

Analyze staged and unstaged changes, create proper commit messages, handle branch safety with intelligent grouping for monorepo changes, push to origin, and create pull requests.

**IMPORTANT SAFETY RULES:**

- NEVER execute force push commands (strictly forbidden)
- NEVER push to main/master branches
- ALWAYS warn about main/master branches
- ALWAYS show complete workflow plan before execution
- SINGLE approval for entire workflow (type yes = proceed)
- NEVER add "Co-authored-by: Claude" or "Generated by Claude Code" to commit messages or PR bodies
- If force push is needed, provide the command but NEVER execute it
- Auto-assign PRs to creator with --assignee @me
- NO additional prompts after approval - full automation

## Context Analysis

### Current Git Status

!`git status --porcelain`

### Current Branch Information

- Current branch: !`git branch --show-current`
- Current branch (symbolic): !`git symbolic-ref HEAD`
- Remote tracking: !`git remote -v`

### Change Analysis

- Staged changes: !`git diff --cached --name-status`
- Unstaged changes: !`git diff --name-status`
- Full staged diff: !`git diff --cached`
- Full unstaged diff: !`git diff`

### Recent Commits for Context

!`git log --oneline -5`

### GitHub CLI Status

!`gh auth status 2>/dev/null || echo "GitHub CLI not authenticated"`

### Repository Structure Context

!`find . -name "package.json" -o -name "pom.xml" -o -name "Cargo.toml" -o -name "go.mod" -o -name "requirements.txt" -o -name "composer.json" | head -10`

## Your Task

**Optional context:** $ARGUMENTS

Based on the above analysis, follow this workflow:

### 1. Branch Safety Check

- **Check the current branch name from the context above**
- **IF current branch contains 'main' or 'master':**
  - ‚ö†Ô∏è **WARNING: You are on the main/master branch!**
  - Analyze the changes to suggest an appropriate feature branch name
  - **ASK PERMISSION:** "Do you want me to create a new branch? Suggested name: `feature/[suggested-name]` or `fix/[suggested-name]`"
  - **WAIT FOR APPROVAL** before proceeding
  - If approved, create the branch with: `git checkout -b [branch-name]`

### 2. Change Grouping Analysis

- **For Monorepo:** Analyze if changes span multiple logical components/services
- **Group changes by:**
  - Feature area (frontend, backend, docs, etc.)
  - Change type (feat, fix, docs, style, refactor, test, chore)
  - Dependency relationships
- **IF changes are unrelated:** Suggest multiple commits with clear separation
- **IF changes are related:** Create a single coherent commit

### 3. Commit Message Generation - FIXED FOR APPROPRIATE COMPLEXITY

**Match message length to change complexity:**

#### Simple Changes (1-2 files, obvious scope):

```
type(scope): brief description
```

#### Medium Changes (3-5 related files):

```
type(scope): brief summary

- Main change description
- Additional change description
```

#### Complex Changes (5+ files or major feature):

```
type(scope): brief summary

- Main change description
- Additional change description
- Breaking change note (if applicable)
- Additional details for complex features
```

**Types:** feat, fix, docs, style, refactor, test, chore, ci, perf

**Examples by complexity:**

- **Simple:** `fix(ci): scope permissions to job level`
- **Medium:** `feat(auth): add JWT authentication\n\n- Implement token generation\n- Add middleware`
- **Complex:** `feat(dashboard): implement admin dashboard\n\n- Create user management interface\n- Add role-based access controls\n- Implement data visualization\n- Add export functionality`

### 4. Complete Action Plan

- **Show FULL planned workflow:**

  ```
  üîã COMPLETE WORKFLOW PLAN:

  1Ô∏è‚É£ BRANCH: [current/new branch name]
     Command: git checkout -b [branch-name] (if needed)

  2Ô∏è‚É£ COMMIT(S):
     Commit 1: [commit message - appropriate length]
     Files: [list of files]
     Command: git add [files] && git commit -m "[message]"
     [Additional commits if multiple needed]

  3Ô∏è‚É£ PUSH:
     Target: origin/[branch-name] (if not main/master)
     Command: git push origin [branch-name]

  4Ô∏è‚É£ PULL REQUEST:
     From: [branch-name] ‚Üí main
     Title: [generated from commit]
     Body: [clean description - NO Claude attribution]
     Assignee: @me
     Command: gh pr create --title "[title]" --body "[body]" --assignee @me

  üöÄ Ready to execute ALL steps above?
  ```

### 5. Single Approval & Full Execution - FIXED

- **ASK ONCE:** "Execute complete workflow? (type 'yes' to proceed, or type 'no' to cancel)"
- **WAIT FOR SINGLE APPROVAL** (empty input = yes, anything else = review)
- **After approval, execute ALL steps with ZERO additional prompts:**
  1. Create branch (if needed) - NO PROMPT
  2. Stage and commit files - NO PROMPT
  3. Push to origin (if not main/master) - NO PROMPT
  4. Create PR with assignment - NO PROMPT
  5. Show final summary with links
- **CRITICAL:** No bash interactive prompts, no "press enter" requests, no additional confirmations

### Command Execution - NON-INTERACTIVE

```bash
# Ensure non-interactive execution
git add [files]
git commit -m "[message]"  # Direct execution, no editor
git push origin [branch-name]  # Direct push
gh pr create --title "[title]" --body "[body]" --assignee @me  # Direct creation
```

### 6. Push to Origin (Automatic)

- **ONLY for non-main/master branches**
- **Automatic execution** (no additional approval needed)
- **Push command:** `git push origin [branch-name]`
- **Handle push failures gracefully:**
  - If push fails due to remote changes, suggest: `git pull origin [branch-name]`
  - If push fails requiring force, provide manual command but DO NOT execute

### 7. Pull Request Creation (Automatic) - FIXED

- **ONLY attempt if push was successful**
- **Automatic execution** (no additional approval needed)
- **Auto-assign to creator** with `--assignee @me`
- **Generate PR content - NO CLAUDE ATTRIBUTION:**

#### Simple Changes:

```
Title: [commit message]
Body: [brief description of what changed]
```

#### Complex Changes:

```
Title: [commit summary]
Body: This PR implements [feature] with the following changes:

- [bullet point 1]
- [bullet point 2]
- [bullet point 3]
```

**STRICTLY FORBIDDEN in PR body:**

- ‚ùå "Generated by Claude Code"
- ‚ùå "Co-authored-by: Claude"
- ‚ùå Any AI/Claude attribution

**Command:** `gh pr create --title "[title]" --body "[clean-body]" --assignee @me`

### 8. Final Summary

- Show what was accomplished:
  - ‚úÖ Commits created: [list]
  - ‚úÖ Branch status: [current branch]
  - ‚úÖ Push status: [success/skipped/failed]
  - ‚úÖ PR status: [created/skipped/failed with link]
  - ‚úÖ Assignment: [@me assigned to PR]
- Provide next steps if needed:
  - Manual push commands (if push was skipped)
  - PR link (if created successfully)
  - Manual PR creation instructions (if GitHub CLI unavailable)
- Note any remaining unstaged changes
- **Security reminder:** No force push commands were executed

## Force Push Safety Protocol

**ABSOLUTELY FORBIDDEN:** This workflow will NEVER execute force push commands.

### When Force Push is Required

If a push operation fails and requires force push:

1. **Display the situation clearly:**

   ```
   üö´ PUSH FAILED - Force push required

   Reason: [error message from git]

   ‚ö†Ô∏è  MANUAL ACTION REQUIRED:
   Review the situation carefully, then run ONE of these commands manually:

   Safe option (recommended):
   git push --force-with-lease origin [branch-name]

   Nuclear option (dangerous):
   git push --force origin [branch-name]

   üìñ Learn more: https://git-scm.com/docs/git-push#Documentation/git-push.txt---force-with-lease
   ```

2. **Stop all automated actions**
3. **Wait for manual intervention**

### Why Force Push is Dangerous

- Can overwrite other people's work
- Can cause data loss
- Should only be used with full understanding
- Always prefer `--force-with-lease` over `--force`

## Branch Protection Examples

### Safe Push Examples

‚úÖ **ALLOWED:**

```bash
# Current branch: feature/user-auth
git push origin feature/user-auth
```

üö´ **BLOCKED:**

```bash
# Current branch: main
git push origin main  # ‚Üê BLOCKED!

# Any force push
git push --force origin feature/user-auth  # ‚Üê BLOCKED!
```

## Example Commit Messages by Complexity

### Simple Changes (1-2 files):

```
fix(ci): scope permissions to job level
docs(readme): update installation steps
style(header): fix responsive layout
```

### Medium Changes (3-5 files):

```
feat(auth): add JWT authentication

- Implement token generation and validation
- Add authentication middleware
- Update login/logout endpoints
```

### Complex Changes (5+ files, major features):

```
feat(dashboard): implement admin dashboard

- Create user management interface
- Add role-based access controls
- Implement data visualization components
- Add export functionality
- Include comprehensive test suite
```

## Pull Request Examples - NO CLAUDE ATTRIBUTION

### Simple Change Example:

```
Title: fix(ci): scope permissions to job level
Body: Move workflow permissions from global to job-level scope for better security.
```

### Complex Change Example:

```
Title: feat(auth): add JWT authentication
Body: This PR implements JWT authentication with the following changes:

- Add JWT token generation and validation
- Create authentication middleware
- Update user login/logout endpoints
- Add password hashing with bcrypt
```

### Manual PR Creation Fallback

If GitHub CLI is not available:

```
üîó MANUAL PR CREATION:

1. Visit: https://github.com/[owner]/[repo]/compare/main...feature/auth-system
2. Title: feat(auth): implement JWT authentication system
3. Description: [copy the generated body above - NO Claude attribution]
4. Assignee: Select yourself from dropdown
5. Click "Create Pull Request"
```

Remember: This workflow prioritizes safety, clarity, and team collaboration. Always ask for permission before making branch changes, commits, pushes, or PRs!
